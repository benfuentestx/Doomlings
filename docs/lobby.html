<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doomlings - Lobby</title>
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
  <div class="lobby-container">
    <div class="lobby-header">
      <h1>Game Lobby</h1>
      <p id="waiting-text">Waiting for players...</p>
    </div>

    <div class="game-id-display">
      <label>Share this code with friends:</label>
      <div class="game-id-code" id="game-code">------</div>
      <button class="copy-btn" onclick="copyGameCode()">Copy Code</button>
    </div>

    <div class="players-list">
      <h3>Players (<span id="player-count">0</span>/6)</h3>
      <div id="players-container"></div>
    </div>

    <div class="lobby-actions">
      <button id="ready-btn" class="secondary">Ready</button>
      <button id="start-btn" style="display: none;">Start Game</button>
      <button onclick="leaveLobby()" class="secondary" style="background: var(--danger);">Leave</button>
    </div>
  </div>

  <div id="loading" class="message-overlay" style="display: none;">
    <div class="spinner"></div>
    <p>Connecting...</p>
  </div>

  <script type="module">
    import { peerManager } from './js/peer-manager.js';

    // Get player data from session
    let playerData = JSON.parse(sessionStorage.getItem('playerData'));
    const isHost = sessionStorage.getItem('isHost') === 'true';

    // DOM Elements
    const gameCodeEl = document.getElementById('game-code');
    const playerCountEl = document.getElementById('player-count');
    const playersContainer = document.getElementById('players-container');
    const readyBtn = document.getElementById('ready-btn');
    const startBtn = document.getElementById('start-btn');
    const waitingText = document.getElementById('waiting-text');
    const loadingOverlay = document.getElementById('loading');

    // Check if we have player data
    if (!playerData) {
      window.location.href = 'index.html';
    } else {
      gameCodeEl.textContent = playerData.gameId;

      // Set up callbacks
      peerManager.onGameStateUpdate = (state) => {
        if (state.state === 'playing') {
          window.location.href = 'game.html';
        } else {
          updateFromState(state);
        }
      };

      peerManager.onError = (error) => {
        alert(error);
      };

      peerManager.onDisconnected = () => {
        console.log('Disconnected from host, will retry...');
        // Don't immediately redirect - host may be navigating to game page
        // Wait and retry connection
        setTimeout(() => {
          retryConnection();
        }, 1500);
      };

      let retryCount = 0;
      const maxRetries = 3;

      async function retryConnection() {
        if (retryCount >= maxRetries) {
          alert('Lost connection to host');
          window.location.href = 'index.html';
          return;
        }
        retryCount++;
        console.log(`Retry attempt ${retryCount}/${maxRetries}`);
        try {
          // Preserve playerId for reconnection
          if (playerData.playerId) {
            peerManager.myPlayerId = playerData.playerId;
          }
          const result = await peerManager.joinGame(playerData.gameId, playerData.playerName);
          if (result.success) {
            playerData.playerId = result.playerId;
            sessionStorage.setItem('playerData', JSON.stringify(playerData));
            retryCount = 0;
          }
        } catch (err) {
          setTimeout(retryConnection, 1500);
        }
      }

      // Restore connection based on host/client status
      initializeConnection();
    }

    async function initializeConnection() {
      try {
        if (isHost) {
          // Host needs to restore their peer connection
          await peerManager.restoreHost(playerData.gameId, playerData.playerId, playerData.playerName);
          loadingOverlay.style.display = 'none';
          updateUI();
        } else {
          // Client needs to join the game
          // Preserve existing playerId if we have one (for reconnection scenarios)
          if (playerData.playerId) {
            peerManager.myPlayerId = playerData.playerId;
          }
          const result = await peerManager.joinGame(playerData.gameId, playerData.playerName);
          loadingOverlay.style.display = 'none';
          if (result.success) {
            playerData.playerId = result.playerId;
            sessionStorage.setItem('playerData', JSON.stringify(playerData));
          }
        }
      } catch (err) {
        loadingOverlay.style.display = 'none';
        alert(err.error || 'Failed to connect. Please try again.');
        window.location.href = 'index.html';
      }
    }

    // Update UI from game state
    function updateFromState(state) {
      updatePlayersList(state.players);
    }

    // Update UI directly from peer manager
    function updateUI() {
      const players = peerManager.getPlayers();
      if (players.length > 0) {
        updatePlayersList(players);
      }
    }

    // Update players list
    function updatePlayersList(players) {
      playerCountEl.textContent = players.length;
      playersContainer.innerHTML = '';

      players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-item';

        const isMe = player.id === playerData.playerId;

        div.innerHTML = `
          <span class="player-name">
            ${player.name}${isMe ? ' (You)' : ''}
            ${player.isHost ? '<span class="host-badge">HOST</span>' : ''}
          </span>
          <span class="ready-status ${player.ready ? 'ready' : 'waiting'}">
            ${player.ready ? 'Ready' : 'Not Ready'}
          </span>
        `;

        playersContainer.appendChild(div);
      });

      // Update waiting text
      const readyCount = players.filter(p => p.ready).length;
      const notHostCount = players.filter(p => !p.isHost).length;
      const notHostReadyCount = players.filter(p => !p.isHost && p.ready).length;

      if (players.length < 2) {
        waitingText.textContent = 'Need at least 2 players to start';
      } else if (notHostReadyCount < notHostCount) {
        waitingText.textContent = `Waiting for ${notHostCount - notHostReadyCount} player(s) to ready up...`;
      } else {
        waitingText.textContent = 'All players ready! Host can start the game.';
      }

      updateButtons();
    }

    // Update button states
    function updateButtons() {
      if (isHost) {
        readyBtn.style.display = 'none';
        startBtn.style.display = 'block';
      } else {
        readyBtn.style.display = 'block';
        startBtn.style.display = 'none';

        const me = peerManager.getPlayers().find(p => p.id === playerData.playerId);
        if (me) {
          readyBtn.textContent = me.ready ? 'Not Ready' : 'Ready';
          readyBtn.className = me.ready ? 'secondary' : '';
        }
      }
    }

    // Ready toggle
    readyBtn.addEventListener('click', () => {
      peerManager.toggleReady();
    });

    // Start game (host only)
    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      startBtn.textContent = 'Starting...';

      const result = peerManager.startGame();

      if (!result.success) {
        alert(result.error || 'Failed to start game');
        startBtn.disabled = false;
        startBtn.textContent = 'Start Game';
      }
      // On success, onGameStateUpdate will redirect us
    });

    // Copy game code
    window.copyGameCode = function() {
      navigator.clipboard.writeText(playerData.gameId).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy Code', 2000);
      });
    };

    // Leave lobby
    window.leaveLobby = function() {
      peerManager.disconnect();
      sessionStorage.removeItem('playerData');
      sessionStorage.removeItem('isHost');
      sessionStorage.removeItem('gameStateBackup');
      window.location.href = 'index.html';
    };

    // Periodic UI refresh for host
    if (isHost) {
      setInterval(updateUI, 500);
    }
  </script>
</body>
</html>
