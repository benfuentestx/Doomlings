<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doomlings - Lobby</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="lobby-container">
    <div class="lobby-header">
      <h1>Game Lobby</h1>
      <p id="waiting-text">Waiting for players...</p>
    </div>

    <div class="game-id-display">
      <label>Share this code with friends:</label>
      <div class="game-id-code" id="game-code">------</div>
      <button class="copy-btn" onclick="copyGameCode()">Copy Code</button>
    </div>

    <div class="players-list">
      <h3>Players (<span id="player-count">0</span>/6)</h3>
      <div id="players-container"></div>
    </div>

    <div class="lobby-actions">
      <button id="ready-btn" class="secondary">Ready</button>
      <button id="start-btn" style="display: none;">Start Game</button>
      <button onclick="leaveLobby()" class="secondary" style="background: var(--danger);">Leave</button>
    </div>
  </div>

  <div id="loading" class="message-overlay">
    <div class="spinner"></div>
    <p>Connecting...</p>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Get player data from session
    let playerData = JSON.parse(sessionStorage.getItem('playerData'));

    // DOM Elements
    const gameCodeEl = document.getElementById('game-code');
    const playerCountEl = document.getElementById('player-count');
    const playersContainer = document.getElementById('players-container');
    const readyBtn = document.getElementById('ready-btn');
    const startBtn = document.getElementById('start-btn');
    const waitingText = document.getElementById('waiting-text');
    const loadingOverlay = document.getElementById('loading');

    // Check if we have player data
    if (!playerData) {
      window.location.href = '/';
    } else {
      // Reconnect to game
      socket.emit('joinGame', {
        gameId: playerData.gameId,
        playerName: playerData.playerName
      }, (response) => {
        loadingOverlay.style.display = 'none';

        if (response.success) {
          playerData = response;
          sessionStorage.setItem('playerData', JSON.stringify(playerData));
          gameCodeEl.textContent = playerData.gameId;
          updatePlayersList(response.players || []);
          updateButtons();
        } else {
          alert('Failed to reconnect: ' + (response.error || 'Unknown error'));
          sessionStorage.removeItem('playerData');
          window.location.href = '/';
        }
      });
    }

    // Listen for lobby updates
    socket.on('lobbyUpdate', (data) => {
      updatePlayersList(data.players);
      updateButtons();
    });

    // Listen for game start
    socket.on('gameState', (state) => {
      if (state.state === 'playing') {
        sessionStorage.setItem('gameState', JSON.stringify(state));
        window.location.href = '/game.html';
      }
    });

    // Update players list
    function updatePlayersList(players) {
      playerCountEl.textContent = players.length;
      playersContainer.innerHTML = '';

      players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-item';

        const isMe = player.id === playerData.playerId;

        div.innerHTML = `
          <span class="player-name">
            ${player.name}${isMe ? ' (You)' : ''}
            ${player.isHost ? '<span class="host-badge">HOST</span>' : ''}
          </span>
          <span class="ready-status ${player.ready ? 'ready' : 'waiting'}">
            ${player.ready ? 'Ready' : 'Not Ready'}
          </span>
        `;

        playersContainer.appendChild(div);

        // Update local data
        if (isMe) {
          playerData.isHost = player.isHost;
          playerData.ready = player.ready;
        }
      });

      // Update waiting text
      const readyCount = players.filter(p => p.ready).length;
      const notHostCount = players.filter(p => !p.isHost).length;
      const notHostReadyCount = players.filter(p => !p.isHost && p.ready).length;

      if (players.length < 2) {
        waitingText.textContent = 'Need at least 2 players to start';
      } else if (notHostReadyCount < notHostCount) {
        waitingText.textContent = `Waiting for ${notHostCount - notHostReadyCount} player(s) to ready up...`;
      } else {
        waitingText.textContent = 'All players ready! Host can start the game.';
      }
    }

    // Update button states
    function updateButtons() {
      if (playerData.isHost) {
        readyBtn.style.display = 'none';
        startBtn.style.display = 'block';
      } else {
        readyBtn.style.display = 'block';
        startBtn.style.display = 'none';
        readyBtn.textContent = playerData.ready ? 'Not Ready' : 'Ready';
        readyBtn.className = playerData.ready ? 'secondary' : '';
      }
    }

    // Ready toggle
    readyBtn.addEventListener('click', () => {
      socket.emit('toggleReady', (response) => {
        if (response.success) {
          playerData.ready = response.ready;
          updateButtons();
        }
      });
    });

    // Start game (host only)
    startBtn.addEventListener('click', () => {
      startBtn.disabled = true;
      startBtn.textContent = 'Starting...';

      socket.emit('startGame', (response) => {
        if (!response.success) {
          alert(response.error || 'Failed to start game');
          startBtn.disabled = false;
          startBtn.textContent = 'Start Game';
        }
        // On success, gameState event will redirect us
      });
    });

    // Copy game code
    function copyGameCode() {
      navigator.clipboard.writeText(playerData.gameId).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy Code', 2000);
      });
    }

    // Leave lobby
    function leaveLobby() {
      sessionStorage.removeItem('playerData');
      window.location.href = '/';
    }

    // Handle disconnect
    socket.on('disconnect', () => {
      loadingOverlay.querySelector('p').textContent = 'Reconnecting...';
      loadingOverlay.style.display = 'block';
    });

    socket.on('connect', () => {
      if (playerData) {
        socket.emit('joinGame', {
          gameId: playerData.gameId,
          playerName: playerData.playerName
        }, (response) => {
          loadingOverlay.style.display = 'none';
          if (response.success) {
            updatePlayersList(response.players || []);
          }
        });
      }
    });
  </script>
</body>
</html>
